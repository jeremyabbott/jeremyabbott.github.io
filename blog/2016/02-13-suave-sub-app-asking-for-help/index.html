<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Jeremy Abbott</title>
    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <link rel="stylesheet" href="/assets/resources/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/resources/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/stylesheets/pygment_trac.css">

    <!-- FSharp.Formatting Styles -->
    <link rel="stylesheet" type="text/css" media="screen" href="/fsharp.formatting/tooltips.css" />
    <script type="text/javascript" src="/fsharp.formatting/tooltips.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="alternate" type="application/rss+xml" title="" href="/rss.xml">
</head>
<body>
    <!-- Mobile Nav Section -->
    <nav class="navbar navbar-default visible-xs" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a type="button" class="navbar-toggle nav-link" href="http://github.com/jeremyabbott">
                <i class="fa fa-github"></i>
            </a>

            <a type="button" class="navbar-toggle nav-link" href="http://twitter.com/mrjabbott">
                <i class="fa fa-twitter"></i>
            </a>
            <a type="button" class="navbar-toggle nav-link" href="mailto:jeremymabbott@gmail.com">
                <i class="fa fa-envelope"></i>
            </a>
            <a class="navbar-brand" href="/">
                <img src="http://www.gravatar.com/avatar/d2087702a492be991c18b4dc0fed20d1.png?s=35" class="img-circle" />
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active"><a href="/">Home</a></li>
                <li><a href="/blog/index.html">Blog</a></li>
                <li><a href="http://resumejeremyabbott.azurewebsites.net/">R√©sum√©</a></li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </nav>

    <!-- nav-menu-dropdown -->
    <div class="btn-group hidden-xs" id="nav-menu">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            <i class="fa fa-bars"></i>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a href="/"><i class="fa fa-home"></i>Home</a></li>
            <li><a href="/blog"><i class="fa fa-pencil"></i>Blog</a></li>
            <li><a href="http://resumejeremyabbott.azurewebsites.net/"><i class="fa fa-file-pdf-o"></i>R√©sum√©</a></li>
            <li class="divider"></li>
            <li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
        </ul>
    </div>

    <!-- sidebar -->
    <div class="col-sm-3 sidebar hidden-xs">
        <header class="sidebar-header" role="banner">
            <a href="/">
                <img src="http://www.gravatar.com/avatar/d2087702a492be991c18b4dc0fed20d1?s=150" class="img-circle" />
            </a>
            <h3 class="title">
                <a href="/">Jeremy Abbott</a>
            </h3>
            </header>
        <div id="bio" class="text-center">
        <p>Too Gay to Œª</p>
        <p>üåàHuman, ‚úäüèº‚Äèactivist, software engineer, functional programming enthusiast, occassional conference speaker.</p>
        </div>
        <div id="contact-list" class="text-center">
            <ul class="list-unstyled list-inline">
                <li>
                    <a class="btn btn-default btn-sm" href="https://github.com/jeremyabbott">
                        <i class="fa fa-github-alt fa-lg"></i>
                    </a>
                </li>
                <li>
                    <a class="btn btn-default btn-sm" href="https://twitter.com/mrjabbott">
                        <i class="fa fa-twitter fa-lg"></i>
                    </a>
                </li>
                <li>
                    <a class="btn btn-default btn-sm" href="mailto:jeremymabbott@gmail.com">
                        <i class="fa fa-envelope fa-lg"></i>
                    </a>
                </li>
            </ul>
            <ul id="contact-list-secondary" class="list-unstyled list-inline">
                <li>
                    <a class="btn btn-default btn-sm" href="/rss.xml">
                        <i class="fa fa-rss fa-lg"></i>
                    </a>
                </li>
                <li>
                    <a class="btn btn-default btn-sm" href="http://resumejeremyabbott.azurewebsites.net/">
                        <i class="fa fa-file-text-o fa-lg"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- content -->
    <div class="col-sm-9 col-sm-offset-3">
        <div class="page-header">
            <h1>Jeremy Abbott</h1>
            <em>(Not the Figure Skater)</em>
        </div>
        <div class="container">
            <h1>Hosting Suave as a Sub App in IIS & Asking for Help</h1>


<p>While experimenting with <a href="https://suave.io/">Suave</a> for a side project I wanted to deploy it locally to IIS to see how <a href="http://www.iis.net/downloads/microsoft/httpplatformhandler">HttpPlatformHandler</a> (<a href="http://azure.microsoft.com/blog/2015/02/04/announcing-the-release-of-the-httpplatformhandler-module-for-iis-8/">more info</a>) worked. Easy enough, right?! Actually yes, but it took me a long time (several evenings) to get it right.</p>
<p>First let's take a look at how to host a Suave app as a sub app in IIS. The requirements are pretty straightforward. In fact, you can follow <a href="http://www.hanselman.com/blog/RunningSuaveioAndFWithFAKEInAzureWebAppsWithGitAndTheDeployButton.aspx">Scott Hanselman's post about deploying Suave to Azure</a> and get most of the way there. Before you do anything else <a href="http://www.iis.net/downloads/microsoft/httpplatformhandler">download</a> and install version 1.2 of the HttpPlatformHandler IIS module.</p>
<p>After you've installed the HttpPlatformHandler module you can verify that it's installed in IIS by checking in IIS:</p>
<p><img src="/images/iishome.png" alt="IIS Home Screen" title="IIS Home" /></p>
<p>Double click on the "Modules" icon in the "IIS" section.</p>
<p><img src="/images/iismodules.png" alt="IIS Modules Screen" title="IIS Modules" /></p>
<br />
<br />
<p>Next let's set up a simple F# script that will run a Suave application. A simple way to do this is to create an F# tutorial project in Visual Studio. From the "New Project" dialogue select "Visual F#" and then "Tutorial".</p>
<p><img src="/images/vsFsharpTutorialDialogue.png" alt="Visual Studio New Project Dialogue" title="Visual Studio New Project Dialogue" /></p>
<br />
<br />
<p>The tutorial template simplifies setup because it gives you an F# script file by default, but also makes it really easy to add the NuGet packages we're going to need. Go ahead and add packages for <code>Suave</code> and <code>FAKE</code>.</p>
<p>When you're done your project should look similar to this in Visual Studio's solution explorer:</p>
<p><img src="/images/suavesolutionexplorer.png" alt="Visual Studio Solution Explorer" title="Visual Studio Solution Explorer" /></p>
<br />
<br />
<p>Aside: if we wanted to be more idiomatically F# we'd use <a href="https://fsprojects.github.io/Paket/">Paket</a> instead of NuGet, but let's not add too many new ideas at once.</p>
<p>Now that we have our project setup let's write some code. Replace the code in <code>Tutorial.fsx</code> with the following:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#I</span> <span class="s">&quot;./packages/Suave.1.1.1/lib/net40&quot;</span>
<span class="prep">#I</span> <span class="s">&quot;./packages/FAKE.4.20.0/tools&quot;</span>
<span class="prep">#r</span> <span class="s">&quot;Suave.dll&quot;</span>
<span class="prep">#r</span> <span class="s">&quot;FakeLib.dll&quot;</span>

<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">System</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 2)" onmouseover="showTip(event, 'fs1', 2)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">Net</span>
<span class="k">open</span> <span class="i">Fake</span>
<span class="k">open</span> <span class="i">Suave</span>
<span class="k">open</span> <span class="i">Suave</span><span class="o">.</span><span class="i">Filters</span>
<span class="k">open</span> <span class="i">Suave</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 4)" onmouseover="showTip(event, 'fs3', 4)" class="i">Operators</span>
<span class="k">open</span> <span class="i">Suave</span><span class="o">.</span><span class="i">Successful</span>

<span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="t">Environment</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="i">CurrentDirectory</span> <span class="o">&lt;-</span> <span class="k">__SOURCE_DIRECTORY__</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">app</span> <span class="o">=</span>
    <span class="i">choose</span> [
            <span class="i">path</span> <span class="s">&quot;/hello&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;Hello!&quot;</span>
            <span class="i">path</span> <span class="s">&quot;/goodbye&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;Good bye!&quot;</span>]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">port</span> <span class="o">=</span> <span class="i">getBuildParamOrDefault</span> <span class="s">&quot;port&quot;</span> <span class="s">&quot;8083&quot;</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs8', 9)" onmouseover="showTip(event, 'fs8', 9)" class="f">uint16</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs9', 10)" onmouseover="showTip(event, 'fs9', 10)" class="i">config</span> <span class="o">=</span>
    { <span class="i">defaultConfig</span> <span class="k">with</span>
        <span class="i">bindings</span> <span class="o">=</span> [<span class="i">HttpBinding</span><span class="o">.</span><span class="i">mk</span> <span class="i">HTTP</span> <span onmouseout="hideTip(event, 'fs10', 11)" onmouseover="showTip(event, 'fs10', 11)" class="i">IPAddress</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 12)" onmouseover="showTip(event, 'fs11', 12)" class="i">Loopback</span> <span onmouseout="hideTip(event, 'fs7', 13)" onmouseover="showTip(event, 'fs7', 13)" class="i">port</span>]
    }

<span class="i">startWebServer</span> <span class="i">config</span> <span onmouseout="hideTip(event, 'fs6', 14)" onmouseover="showTip(event, 'fs6', 14)" class="i">app</span>
</code></pre></td>
</tr>
</table>
<p>Here's a quick explanation about the script-specific bits of code. Lines 1 &amp; 2 tell FSI to include the directories where <code>Suave</code> and <code>FAKE</code> live when a DLL is referenced. Lines 3 &amp; 4 can be written that way (as opposed to including a relative path) because of the code at lines 1&amp; 2. Once the assemblies are referenced we still need to open the specific namespaces that we're going to use.</p>
<p>This script will start a Suave web app using either the default port # (8083) or one given to it from a caller. At this point you can run the app in FSI and navigate to <a href="http://localhost:8083">http://localhost:8083</a> in your browser.</p>
<p>We need to one more thing before we can host this app in IIS (actually two, but I'm getting ahead of myself). Regardless of the technology (ASP.NET MVC, Suave, Java, Rails, etc.), a site hosted in IIS needs a web.config. Let's add one now:</p>
<p><img src="/images/addwebconfig.png" alt="Add an Application Configuration File named &quot;web.config&quot;" title="Add Web.Config" /></p>
<br />
<br />
<p>And here's what should go in the <code>web.config</code>:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="o">&lt;?</span><span class="i">xml</span> <span class="i">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span> <span class="i">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="i">configuration</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="i">system</span><span class="o">.</span><span class="i">webServer</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="i">handlers</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="i">remove</span> <span class="i">name</span><span class="o">=</span><span class="s">&quot;httpplatformhandler&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="i">add</span> <span class="i">name</span><span class="o">=</span><span class="s">&quot;httpplatformhandler&quot;</span> <span class="i">path</span><span class="o">=</span><span class="s">&quot;*&quot;</span> <span class="i">verb</span><span class="o">=</span><span class="s">&quot;*&quot;</span> <span class="i">modules</span><span class="o">=</span><span class="s">&quot;httpPlatformHandler&quot;</span> <span class="i">resourceType</span><span class="o">=</span><span class="s">&quot;Unspecified&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="i">handlers</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="i">httpPlatform</span>
            <span class="i">stdoutLogEnabled</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="i">startupTimeLimit</span><span class="o">=</span><span class="s">&quot;20&quot;</span>
            <span class="i">processPath</span><span class="o">=</span><span class="s">&quot;./packages/FAKE.4.20.0/tools/FAKE.exe&quot;</span>
            <span class="i">arguments</span><span class="o">=</span><span class="s">&quot;./Tutorial.fsx port=%HTTP_PLATFORM_PORT%&quot;</span> <span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="i">httpPlatform</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="i">system</span><span class="o">.</span><span class="i">webServer</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="i">configuration</span><span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>
<p>The web.config is pretty straightforward. When IIS sees the <code>httpPlatform</code> section it will run the <code>FAKE</code> executable defined in <code>processPath</code> passing it <code>./Tutorial.fsx port=%HTTP_PLATFORM_PORT%</code> as the argument replacing <code>%HTTP_PLATFORM_PORT%</code> with a port that's not in use.</p>
<p>Now we can create a sub-application in IIS. Create a directory that will host the application. I used <code>C:/sites/SuaveSubApp</code>. After you've created the directory copy the <code>web.config</code> and <code>Tutorial.fsx</code> files, and the <code>packages</code> folder into that directory. Now open up IIS and right-click on the Default Web Site and click "Add Application".</p>
<p><img src="/images/iisdefaultwebsite.png" alt="IIS Default Web Site" title="IIS Default Web Site" /></p>
<p>The application's alias should be the name of the folder that contains it. So if the folder's name is "SuaveSubApp" that's what the alias should be. The application's physical path is the path to that folder.</p>
<p><img src="/images/iisaddapplication.png" alt="IIS Add Application" title="IIS Add Application" /></p>
<p>Awesome! Now if you go to <code>http://localhost/SuaveSubApp/hello</code> you'll see your "Hello!" message... Except that doesn't happen at all. ¬Ø_(„ÉÑ)_/¬Ø</p>
<p><img src="/images/suavebadgateway.png" alt="HTTP Error 502.3 - Bad Gateway" title="HTTP Error 502.3 - Bad Gateway" /></p>
<h2>What Am I Doing Wrong?</h2>
<p><em>When we added the web.config I mentioned that there was actually one other thing we would need to do. When I was trying to set this up the first time I forgot this critical step.</em></p>
<p>What's going on? If you look in the sub-application folder HttpPlatformHandler has generated some nice log messages for you. Maybe those will help? Unfortanately they don't in this case, but it's good to know for future reference. The site is running as it should so you won't find a friendly error message to point you in the right direction.</p>
<p>This is where the "asking for help" bit of this post comes in. I run web applications as sub-applications every day at work. What was I doing wrong this time? I thrashed on this problem for a while (several evenings in fact). And because I knew it had to be something "really simple" I really didn't want to ask for help. "I don't want to waste anyone else's time", I told myself. That's actually only half true. The other half was that I didn't want someone to find out I was stupid which is what I had already decided was the problem. In hindsight my time is way more valuable than my ego, and I should have asked for help sooner. Also, asking for help gives me the opportunity to help someone else who has the same or similar problem in the future.</p>
<p>So finally I asked for help. <a href="http://stackoverflow.com/questions/34868221/suave-app-hosted-on-iis-with-httpplatformhandler-closes-connection">I asked this question on Stack Overflow</a>, and then I shared the question on Twitter. The super awesome <a href="https://twitter.com/haneycodes">David Haney</a> ended up answering my question on Twitter first. He took time out from being in paradise (Hawaii) to help me out which is doubly awesome. Over on Stack Overflow, <a href="https://twitter.com/ad3mar/">Ademar</a>, who happens to be one of the core contributors to Suave, also answered my question. Thanks again to both of you!</p>
<p>Here's the answer: Ultimately when you host an application as a sub-application in IIS it really is part of the main application for the purpose of routing/URLs. In our case we're making a request to a directory under Default Web Site (Default Web Site/SuaveSubApp/). This means "/SuaveSubApp/hello" is getting passed to the sub-application instead of "/hello" like I was expecting. When I'm running the application from FSI it <strong>is</strong> the application. So when I make a request to "<a href="http://localhost:8083/hello"">http://localhost:8083/hello"</a> while the app is running from FSI "/hello" gets matched because the application is the root.</p>
<p>This ended up being a humbling learning experience. When I'm playing with a new technology, trying out a new recipe, or really doing anything I haven't done before, I let the newness (and fear of failure) distract me from the actual problem I'm trying to solve. This is where a decent mindfulness practice and remembering to be in the moment is helpful. In my case this meant knowing that I'd done this before, and that I knew what steps to take, instead of letting the newness of the framework intimidate me. It also means that when all of that fails (and it will) it really is okay to ask for help.</p>
<h2>Examining Requests in Suave</h2>
<p>After figuring out what the problem was I obsessed over how I could have figured it out sooner.</p>
<p>If you look at the incoming request to the application you'll find that the request path getting passed to the <code>choose</code> function doesn't match any of the defined routes. One easy way to find this information is to examine the request itself. Let's add a function that handles the case where the request doesn't match any of our routes:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">notFound</span> <span class="o">=</span>
    <span class="i">warbler</span>(<span class="k">fun</span> <span class="i">r</span> <span class="k">-&gt;</span>
                <span class="i">OK</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs12', 15)" onmouseover="showTip(event, 'fs12', 15)" class="i">sprintf</span> <span class="s">&quot;No route matching %A&quot;</span> <span class="i">r</span><span class="o">.</span><span class="i">request</span><span class="o">.</span><span class="i">url</span><span class="o">.</span><span class="i">AbsolutePath</span>)

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs6', 16)" onmouseover="showTip(event, 'fs6', 16)" class="i">app</span> <span class="o">=</span>
    <span class="i">choose</span> [
            <span class="i">path</span> <span class="s">&quot;/hello&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;Hello!&quot;</span>
            <span class="i">path</span> <span class="s">&quot;/goodbye&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;Good bye!&quot;</span>
            <span class="i">notFound</span> ]
</code></pre></td>
</tr>
</table>
<p>We create a function, <code>notFound</code>, that gets called when <code>choose</code> can't find a matching route. The <code>notFound</code> function uses Suave's <code>warbler</code> function to give us a chance to look at the httpContext's request before returning a WebPart. Maybe this can give us some insight into what's happening? Copy the updated Tutorial.fsx into the sub-application directory, recycle the application pool used by the by the sub-application, and try to hit the app again.</p>
<p>You can recycle the application pool in IIS by going to Application Pools -&gt; DefaultAppPool and then clicking the "Recycle" button in the "Actions" pane on the right-hand side of the window.</p>
<p><img src="/images/iisrecycleapppool.png" alt="IIS - Recycle App Pool" title="IIS - Recycle App Pool" /></p>
<br />
<br />
<p>After refreshing the page we get the following: "No route matching "/SuaveSubApp/hello". This tells us two things: 1) our <code>/hello</code> and <code>/goodbye</code> routes are not being hit, and 2) that the path getting passed to the application is "/SuaveSubApp/hello". So if we change our routes to "/{SubAppName}/path" they'll work, right? Let's find out. Update the routes to the following:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs6', 17)" onmouseover="showTip(event, 'fs6', 17)" class="i">app</span> <span class="o">=</span>
    <span class="i">choose</span> [
            <span class="i">path</span> <span class="s">&quot;/SuaveSubApp/hello&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;Hello!&quot;</span>
            <span class="i">path</span> <span class="s">&quot;/SuaveSubApp/goodbye&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;Good bye!&quot;</span>
            <span class="i">notFound</span> ]
</code></pre></td>
</tr>
</table>
<p>Recycle the app pool again and then refresh the page. Now the request's absolute path matches the path defined in our route and we get back "hello."</p>
<p>We don't really want to hardcode the sub-application path into our routes, especially since we don't always have one so let's clean this up. We'll add the sub-application name as an argument to FAKE when the application starts. Upate the <code>arguments</code> attribute of <code>httpPlatform</code> in the <code>web.config</code> like this:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">arguments</span><span class="o">=</span><span class="s">&quot;./Tutorial.fsx port=%HTTP_PLATFORM_PORT% subPath=&amp;quot;/SuaveSubApp&amp;quot;&quot;</span> <span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>
<p>Then update <code>Tutorial.fsx</code> with the following:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">subPath</span> <span class="o">=</span> <span class="i">getBuildParamOrDefault</span> <span class="s">&quot;subPath&quot;</span> <span class="s">&quot;&quot;</span>

<span class="k">let</span> <span class="i">mapSubPath</span> <span class="i">p</span> <span class="o">=</span> <span class="i">path</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs12', 18)" onmouseover="showTip(event, 'fs12', 18)" class="i">sprintf</span> <span class="s">&quot;%s%s&quot;</span> <span class="i">subPath</span> <span class="i">p</span>
</code></pre></td>
</tr>
</table>
<p>Finally update your routes:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs6', 19)" onmouseover="showTip(event, 'fs6', 19)" class="i">app</span> <span class="o">=</span>
    <span class="i">choose</span> [
            <span class="i">mapSubPath</span> <span class="s">&quot;/hello&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;hello!&quot;</span>
            <span class="i">mapSubPath</span> <span class="s">&quot;/goodbye&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;Good bye!&quot;</span>
            <span class="i">notFound</span> ]
</code></pre></td>
</tr>
</table>
<p>If we have a subPath argument we'll append it to the route we pass to the <code>path</code> function. If there isn't a subPath argument then <code>subPath</code> is an empty string and nothing really changes. Doing it this way we can run our site from FSI or IIS without having to hardcode the routes based on where the application is running.</p>
<h2>Wrap Up</h2>
<p>Here's the final F# script with all the necessary changes:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#I</span> <span class="s">&quot;./packages/Suave.1.1.1/lib/net40&quot;</span>
<span class="prep">#I</span> <span class="s">&quot;./packages/FAKE.4.20.0/tools&quot;</span>
<span class="prep">#r</span> <span class="s">&quot;Suave.dll&quot;</span>
<span class="prep">#r</span> <span class="s">&quot;FakeLib.dll&quot;</span>

<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 20)" onmouseover="showTip(event, 'fs1', 20)" class="i">System</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 21)" onmouseover="showTip(event, 'fs1', 21)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 22)" onmouseover="showTip(event, 'fs2', 22)" class="i">Net</span>
<span class="k">open</span> <span class="i">Fake</span>
<span class="k">open</span> <span class="i">Suave</span>
<span class="k">open</span> <span class="i">Suave</span><span class="o">.</span><span class="i">Filters</span>
<span class="k">open</span> <span class="i">Suave</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 23)" onmouseover="showTip(event, 'fs3', 23)" class="i">Operators</span>
<span class="k">open</span> <span class="i">Suave</span><span class="o">.</span><span class="i">Successful</span>

<span onmouseout="hideTip(event, 'fs4', 24)" onmouseover="showTip(event, 'fs4', 24)" class="i">Environment</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs5', 25)" onmouseover="showTip(event, 'fs5', 25)" class="i">CurrentDirectory</span> <span class="o">&lt;-</span> <span class="k">__SOURCE_DIRECTORY__</span>

<span class="k">let</span> <span class="i">subPath</span> <span class="o">=</span> <span class="i">getBuildParamOrDefault</span> <span class="s">&quot;subPath&quot;</span> <span class="s">&quot;&quot;</span>

<span class="k">let</span> <span class="i">mapSubPath</span> <span class="i">p</span> <span class="o">=</span> <span class="i">path</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs12', 26)" onmouseover="showTip(event, 'fs12', 26)" class="i">sprintf</span> <span class="s">&quot;%s%s&quot;</span> <span class="i">subPath</span> <span class="i">p</span>

<span class="k">let</span> <span class="i">notFound</span> <span class="o">=</span>
    <span class="i">warbler</span>(<span class="k">fun</span> <span class="i">r</span> <span class="k">-&gt;</span>
                <span class="i">OK</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs12', 27)" onmouseover="showTip(event, 'fs12', 27)" class="i">sprintf</span> <span class="s">&quot;No route matching %A&quot;</span> <span class="i">r</span><span class="o">.</span><span class="i">request</span><span class="o">.</span><span class="i">url</span><span class="o">.</span><span class="i">AbsolutePath</span>)

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs6', 28)" onmouseover="showTip(event, 'fs6', 28)" class="i">app</span> <span class="o">=</span>
    <span class="i">choose</span> [
            <span class="i">mapSubPath</span> <span class="s">&quot;/hello&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;hello!&quot;</span>
            <span class="i">mapSubPath</span> <span class="s">&quot;/goodbye&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span class="i">OK</span> <span class="s">&quot;Good bye!&quot;</span>
            <span class="i">notFound</span> ]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs7', 29)" onmouseover="showTip(event, 'fs7', 29)" class="i">port</span> <span class="o">=</span> <span class="i">getBuildParamOrDefault</span> <span class="s">&quot;port&quot;</span> <span class="s">&quot;8083&quot;</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs8', 30)" onmouseover="showTip(event, 'fs8', 30)" class="i">uint16</span>

<span class="k">let</span> <span class="i">config</span> <span class="o">=</span>
    { <span class="i">defaultConfig</span> <span class="k">with</span>
        <span class="i">bindings</span> <span class="o">=</span> [<span class="i">HttpBinding</span><span class="o">.</span><span class="i">mk</span> <span class="i">HTTP</span> <span onmouseout="hideTip(event, 'fs10', 31)" onmouseover="showTip(event, 'fs10', 31)" class="i">IPAddress</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 32)" onmouseover="showTip(event, 'fs11', 32)" class="i">Loopback</span> <span onmouseout="hideTip(event, 'fs7', 33)" onmouseover="showTip(event, 'fs7', 33)" class="i">port</span>]
    }

<span class="i">startWebServer</span> <span class="i">config</span> <span onmouseout="hideTip(event, 'fs6', 34)" onmouseover="showTip(event, 'fs6', 34)" class="i">app</span>
</code></pre></td>
</tr>
</table>
<p>And here's the finished web.config:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="o">&lt;?</span><span class="i">xml</span> <span class="i">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span> <span class="i">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="i">configuration</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="i">system</span><span class="o">.</span><span class="i">webServer</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="i">handlers</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="i">remove</span> <span class="i">name</span><span class="o">=</span><span class="s">&quot;httpplatformhandler&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="i">add</span> <span class="i">name</span><span class="o">=</span><span class="s">&quot;httpplatformhandler&quot;</span> <span class="i">path</span><span class="o">=</span><span class="s">&quot;*&quot;</span> <span class="i">verb</span><span class="o">=</span><span class="s">&quot;*&quot;</span> <span class="i">modules</span><span class="o">=</span><span class="s">&quot;httpPlatformHandler&quot;</span> <span class="i">resourceType</span><span class="o">=</span><span class="s">&quot;Unspecified&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="i">handlers</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="i">httpPlatform</span>
            <span class="i">stdoutLogEnabled</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="i">startupTimeLimit</span><span class="o">=</span><span class="s">&quot;20&quot;</span>
            <span class="i">processPath</span><span class="o">=</span><span class="s">&quot;./packages/FAKE.4.20.0/tools/FAKE.exe&quot;</span>
            <span class="i">arguments</span><span class="o">=</span><span class="s">&quot;./Tutorial.fsx port=%HTTP_PLATFORM_PORT% subPath=&amp;quot;/SuaveSubApp&amp;quot;&quot;</span> <span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="i">httpPlatform</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="i">system</span><span class="o">.</span><span class="i">webServer</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="i">configuration</span><span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>
<p>Hopefully you're comfortable with how HttpPlatformHandler works, and with how you can examine an incoming request to a Suave application. I also hope that my reluctance to ask for help resonates with others so that they won't be as hesitant as I was.</p>

<div class="tip" id="fs1">namespace System</div>
<div class="tip" id="fs2">namespace System.Net</div>
<div class="tip" id="fs3">module Operators<br /><br />from Microsoft.FSharp.Core</div>
<div class="tip" id="fs4">type Environment =<br />&#160;&#160;static member CommandLine : string<br />&#160;&#160;static member CurrentDirectory : string with get, set<br />&#160;&#160;static member CurrentManagedThreadId : int<br />&#160;&#160;static member Exit : exitCode:int -&gt; unit<br />&#160;&#160;static member ExitCode : int with get, set<br />&#160;&#160;static member ExpandEnvironmentVariables : name:string -&gt; string<br />&#160;&#160;static member FailFast : message:string -&gt; unit + 1 overload<br />&#160;&#160;static member GetCommandLineArgs : unit -&gt; string[]<br />&#160;&#160;static member GetEnvironmentVariable : variable:string -&gt; string + 1 overload<br />&#160;&#160;static member GetEnvironmentVariables : unit -&gt; IDictionary + 1 overload<br />&#160;&#160;...<br />&#160;&#160;nested type SpecialFolder<br />&#160;&#160;nested type SpecialFolderOption<br /><br />Full name: System.Environment</div>
<div class="tip" id="fs5">property Environment.CurrentDirectory: string</div>
<div class="tip" id="fs6">val app : obj<br /><br />Full name: suavesubappaskingforhelp.app</div>
<div class="tip" id="fs7">val port : uint16<br /><br />Full name: suavesubappaskingforhelp.port</div>
<div class="tip" id="fs8">Multiple items<br />val uint16 : value:&#39;T -&gt; uint16 (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.uint16<br /><br />--------------------<br />type uint16 = UInt16<br /><br />Full name: Microsoft.FSharp.Core.uint16</div>
<div class="tip" id="fs9">val config : obj<br /><br />Full name: suavesubappaskingforhelp.config</div>
<div class="tip" id="fs10">Multiple items<br />type IPAddress =<br />&#160;&#160;new : newAddress:int64 -&gt; IPAddress + 2 overloads<br />&#160;&#160;member Address : int64 with get, set<br />&#160;&#160;member AddressFamily : AddressFamily<br />&#160;&#160;member Equals : comparand:obj -&gt; bool<br />&#160;&#160;member GetAddressBytes : unit -&gt; byte[]<br />&#160;&#160;member GetHashCode : unit -&gt; int<br />&#160;&#160;member IsIPv4MappedToIPv6 : bool<br />&#160;&#160;member IsIPv6LinkLocal : bool<br />&#160;&#160;member IsIPv6Multicast : bool<br />&#160;&#160;member IsIPv6SiteLocal : bool<br />&#160;&#160;...<br /><br />Full name: System.Net.IPAddress<br /><br />--------------------<br />IPAddress(newAddress: int64) : unit<br />IPAddress(address: byte []) : unit<br />IPAddress(address: byte [], scopeid: int64) : unit</div>
<div class="tip" id="fs11">field IPAddress.Loopback</div>
<div class="tip" id="fs12">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>

        </div>
        <footer>
            <hr/>
            <p>Powered by <a href="https://twitter.com/mattdrivendev">MattDrivenDev's</a>&nbsp;<a href="https://github.com/fsprojects/FsBlog">FsBlog</a></p>
            <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/dbtek/dbyll">dbtek</a></small></p>
            <p>
                &copy; 2017
            </p>
        </footer>
    </div>

    <script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>